---
title: "kaggle_housesale"
author: "RenardBao"
date: "2018年12月24日"
output: 
  html_document:
    theme: journal
    toc: true
    toc_depth: 5
    toc_float:
      collapsed: TRUE
      smooth_scroll: TRUE
---
```{r,include=FALSE}
knitr::opts_knit$set(root.dir ="D:/r_project/data-analysis/house_sale_predict")

```

<style> p{line-height: 2em;}</style>
# 前言
> Ask a home buyer to describe their dream house, and they probably won't begin with the height of the basement ceiling or the proximity to an east-west railroad. But this playground competition's dataset proves that much more influences price negotiations than the number of bedrooms or a white-picket fence.  

>  With 79 explanatory variables describing (almost) every aspect of residential homes in Ames, Iowa, this competition challenges you to predict the final price of each home.


這次的資料是來自於[Kaggle](https://www.kaggle.com/c/house-prices-advanced-regression-techniques)，題目是要預測美國愛荷華州的埃姆斯城市的房價。我會進行資料探索、特徵工程和一些資料視覺，最後我會運用LASSO迴歸、XGBoost和SVM來建模，目前我是第885名(TOP19%)，但是隨著時間流逝大概會一直持續下降吧......

# 前置作業

以下是這次會用到的套件
```{r, result = "hide",warning=FALSE,message=FALSE}
library(ggplot2)
library(dplyr)
library(corrplot)
library(caret)
library(gridExtra)
library(scales)
library(ggrepel)
library(randomForest)
library(psych)
library(xgboost)
library(magrittr)
library(stringr)
library(knitr) #for html table
library(kableExtra) #for kable adjust
```


先做一些環境設置。

```{r}

options(scipen = 999)
train <- read.csv("data/train.csv", stringsAsFactors = F)
test <- read.csv("data/test.csv", stringsAsFactors = F)
#之後submission要用到test$id
test_labels <- test$Id
#test資料集沒有saleprice,用NA填補
test$SalePrice <- NA
all <- rbind(train, test)
dim(all)
```


瞄一下資料的結構

```{r}
#因為有長達80個變數,這邊先簡單顯示前15個跟目標變數
str(all[,c(1:15,80)])
```

```{r,message=FALSE,warning=FALSE}
num_var <-  sapply(all, is.numeric) %>% which %>% names()
char_var <- sapply(all, is.character) %>% which %>% names()
cat("數值變數有",length(num_var),"個",",類別變數有",length(char_var),"個")
```

# 初步探索資料
## 目標變數--銷售價格

看下圖可以發現我們的目標變數"銷售價格"，是一個明顯的右偏峰態。想一想其實也很合理，市場上絕大多數的消費者都負擔不起昂貴的房子。如果圖形呈現左偏或者常態峰佈，代表該地區房價偏貴，或許是屬於高級住宅區也不一定。後面我會將銷售價格做log處理將數據轉換成比較符合常態分佈。
```{r saleprice plot}
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot(aes(x = SalePrice)) + 
  geom_histogram(fill="deeppink2",
                 binwidth = 10000) +
  scale_x_continuous(breaks= seq(0, 800000, by=100000),
                     labels = comma)+
  theme_bw() + #去掉背景色
  theme(panel.grid=element_blank(),  #去掉網線
        panel.border=element_blank(),#去掉邊線
        axis.line=element_line(size=1,colour="black")) +
  annotation_custom(tableGrob(summary(all$SalePrice) %>%
                                "["(1:3) %>% as.matrix() %>% 
                                t,rows = NULL), 
                    xmin=400000, xmax=700000, 
                    ymin=75, ymax=150)+
  annotation_custom(tableGrob(summary(all$SalePrice) %>% 
                                round() %>%
                                "["(4:6) %>% 
                                as.matrix() %>% 
                                t,rows = NULL), 
                    xmin=400000, xmax=700000, 
                    ymin=75, ymax=100)


summary(all$SalePrice)

```

## 數值變數和目標變數的相關性
探索資料第二個步驟就是觀察各個變數和目標變數之間的相關性了，好讓我之後特徵工程比較好處理。

```{r corplot, fig.height = 10, fig.width = 14}
cor_numvar <- cor(all[, num_var], use="pairwise.complete.obs")
#排序之後挑出去相關性絕對值大於0.4的
cor_sortname <- 
  sort(cor_numvar[,'SalePrice'], 
       decreasing = TRUE) %>% 
  as.matrix() %>% 
  apply(1, function(x) abs(x)>0.4) %>% 
  which() %>% 
  names()
cor_numvar_sort <- cor_numvar[cor_sortname, cor_sortname]
#相關性視覺化
corrplot.mixed(cor_numvar_sort, tl.col="black", tl.pos = "lt")

```

透過上圖，相關性大於0.5的變數大概有10個、大於0.7則有兩個(OverallQual & GrLivArea)。後面剩餘的相關性章節我會再獨立出OverallQual & GrLivArea這兩個高相關性變數來個別視覺化其和目標變數的關係。

另外，變數間的共線性問題也要處理。例如GargeCars和GargeArea(0.89)、X1stFlrSF和TotalBsmtSF(0.8)、TotRmsAbvGrd和GrLivArea(0.81)、GarageYrBlt和YearBuilt(0.83)等等，這些會在後面特徵工程的部分進行處理。


## OverallQual
```{r OverallQual_visual, fig.height = 10, fig.width = 14}
grid.arrange(all %>% filter(!(is.na(SalePrice))) %>% 
              ggplot(aes(x=factor(OverallQual), y=SalePrice))+
              geom_boxplot(col='dodgerblue2') + 
              labs(x='Overall Quality') +
              scale_y_continuous(breaks= seq(0, 800000, by=100000),
                                 labels = comma),
             all %>% filter(!(is.na(SalePrice))) %>% 
              ggplot(aes(x=OverallQual, y=SalePrice))+
              geom_point(col='dodgerblue2') + 
              geom_smooth(method = "lm", se=FALSE, color="deeppink3") +
              scale_x_continuous(breaks = seq(1,10,1))+
              scale_y_continuous(breaks= seq(0, 800000, by=100000), 
                                 labels = comma))


```
OverallQual和銷售價格明顯的呈現正相關，而且OverallQual越高銷售價格距離也越大(離散程度)。從箱型圖上看來，沒有差異很大的離群值要踢掉，比較明顯的大概是OverallQual第4和第10。

## GrLivArea
```{r GrLivArea, fig.height = 10, fig.width = 14}
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot(aes(x=GrLivArea, y=SalePrice))+
  geom_point(col='dodgerblue2') + 
  geom_smooth(method = "lm", se=FALSE, color="deeppink3") +
  scale_y_continuous(breaks= seq(0, 800000, by=100000), 
                     labels = comma) +
  geom_text_repel(aes(label = ifelse(all$GrLivArea[!is.na(all$SalePrice)]>4500, 
                                     rownames(all), "")))+
  theme_bw() + #去掉背景色
  theme(panel.grid=element_blank(),  #去掉網線
        panel.border=element_blank(),#去掉邊線
        axis.line=element_line(size=1,colour="black"))


```

看起來右下角似乎有怪異的離群值(524,299)，理論上來說居住坪數越高銷售價格應該也不會低到哪裡去。

```{r see_outlier}
#觀察outlier
all[c(524, 1299), c('SalePrice', 'GrLivArea', 'OverallQual')]

```

524和1299這對兄弟超奇怪的，OverallQual的分數為10、GrLivArea又是屬於前段班，照理來說房價應該會貴到天際才對。但是我在這邊暫時先不會踢掉這兩筆資料，他們會列入可疑名單並在後續特徵工程的時候會再拿出來討論，畢竟貿然地踢掉資料是一個奢侈又高風險的行為。

## 觀察NA值
來看看哪些變數包含NA值。

```{r NA, fig.height = 10, fig.width = 14}
na_col <- 
  all[is.na(all) %>% colSums %>% ">"(0) %>% which] %>% 
  sapply(is.na) %>% 
  colSums() %>% 
  sort(decreasing = TRUE) 
na_col
```

我將會在後面特徵工程時連同重新編碼、轉換變數時一併處理NA值。

# 特徵工程
## 資料清洗
### 疑漏值處理

我會在這邊進行遺漏值NA的處理，也會連帶處理跟具有NA變數相關的變數群。

#### Pool
```{r pool1}
na_col[names(na_col) %>% str_detect("Pool") %>% which]
```

##### PoolQC
2909個NA  
PoolQC: Pool quality

*  Ex   Excellent
*  Gd   Good
*  TA   Average/Typical
*  Fa   Fair
*  NA   No Pool


```{r poolQC}
all$PoolQC[is.na(all$PoolQC)] <- 'None'
all$PoolQC<-as.integer(plyr::revalue(all$PoolQC,
                                     c('None' = 0, 'Po' = 1, 
                                       'Fa' = 2, 'TA' = 3,
                                       'Gd' = 4, 'Ex' = 5)))
table(all$PoolQC)
all[all$PoolQC != 0,c("SalePrice","PoolQC","PoolArea","OverallQual")]

all %>% 
  filter(!(is.na(SalePrice)) & PoolQC != 0) %>% 
  ggplot(aes(x = PoolArea, 
             y = SalePrice ,
             size = PoolQC
             )) +
  geom_point(color = "steelblue") +
  theme_bw() + #去掉背景色
  theme(panel.grid=element_blank(),  #去掉網線
        panel.border=element_blank(),#去掉邊線
        axis.line=element_line(size=1,colour="black"))

```

有游泳池的房子只有10間，圖形上顯示Pool相關變數似乎不那麼顯著影響房價。後面特徵工程的時候我或許會把這類別變數轉成是否有游泳池就好，評級可能不太需要。在這邊我先把NA值轉成NO，並且把它轉成類別變數。

##### PoolArea
另一個跟Pool有關的是PoolArea:

```{r PoolArea}
table(all$PoolArea != 0 )
```

竟然有13個值(PoolQC只有10個)。

```{r PoolArea2}
all[all$PoolArea>0 & all$PoolQC == 0, c('SalePrice','PoolArea', 'PoolQC', 'OverallQual')]
```

這三個疑似缺漏值的資料出現在要預測的資料集裡面，我們也不能隨便亂刪掉，只好透過觀察現有的10筆資料來填補PoolQC回去。

```{r PoolArea3}
all[all$PoolArea > 0,] %>% 
  ggplot(aes(x = OverallQual,y = PoolArea)) + 
  geom_point(aes(alpha = PoolQC),
             size = 10,color = 'steelblue') +
  geom_text(aes(label = ifelse(all[all$PoolArea > 0,"PoolArea"]> 0,
                               rownames(all[all$PoolArea > 0,]),
                               "")),nudge_y = 40)  +
  theme_bw() + #去掉背景色
  theme(panel.grid=element_blank(),  #去掉網線
        panel.border=element_blank(),#去掉邊線
        axis.line=element_line(size=1,colour="black"))
```


透過上圖我會把這三個值都填2回去比較合理。

```{r PoolArea4}
all$PoolQC[c(2421,2504,2600)] <- 2

all[all$PoolArea > 0,] %>% 
  ggplot(aes(x = OverallQual,y = PoolArea)) + 
  geom_point(aes(alpha = PoolQC),
             size = 10,color = 'steelblue') +
  geom_text(aes(label = ifelse(all[all$PoolArea > 0,"PoolArea"]> 0,
                               rownames(all[all$PoolArea > 0,]),
                               "")),nudge_y = 25)  +
  theme_bw() + #去掉背景色
  theme(panel.grid=element_blank(),  #去掉網線
        panel.border=element_blank(),#去掉邊線
        axis.line=element_line(size=1,colour="black"))

```


#### Miscellaneous Feature
```{r Miscellaneous Feature}
names(all)[names(all) %>% str_detect("Mis") %>% which]
na_col[names(na_col) %>% str_detect("Mis") %>% which]
```

2814個NA
MiscFeature: Miscellaneous feature not covered in other categories

* Elev Elevator
* Gar2 2nd Garage (if not described in garage section)
* Othr Other
* Shed Shed (over 100 SF)
* TenC Tennis Court
* NA   None 

轉成factor。

```{r MiscFeature}
all$MiscFeature[is.na(all$MiscFeature)] <- "None"
all$MiscFeature <- as.factor(all$MiscFeature)
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot(aes(x=MiscFeature, y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  scale_y_continuous(breaks= seq(0, 800000, by=100000), labels = comma) +
  geom_label(stat = "count", aes(label = ..count.., y = ..count..))+
  theme_bw() + #去掉背景色
  theme(panel.grid=element_blank(),  #去掉網線
        panel.border=element_blank(),#去掉邊線
        axis.line=element_line(size=1,colour="black"))+
  annotate('text',x = 2.4,y = 245000,label = '總共')+
  annotation_custom(tableGrob(table(all$MiscFeature) %>% as.data.frame()%>% t ,rows = NULL), 
                    xmin=0.75, xmax=4, 
                    ymin=180000, ymax=250000)

```


看起來MiscFeature這類別變數沒甚麼相關，絕大多數都是None居多。第二多的shed也沒有明顯和None有差異，差異比較大的TenC和Othr佔的件數又少很多。

##### MiscVal
```{r MiscFeature1}
all %>% filter(!(MiscFeature %in% "None") & MiscVal == 0) %>% select("Id","MiscVal","MiscFeature")
```


這三筆資料我不會去更動它，因為我並不知道價值為0是因為誤植還是它真的就是免費大贈送的。



#### Alley
2721個NA
Alley: Type of alley access to property

* Grvl Gravel
* Pave Paved
* NA   No alley access

轉成factor。

```{r Alley}
all$Alley[is.na(all$Alley)] <- 'None'
all$Alley %<>% as.factor()
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot(aes(x=Alley, y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2')+
  scale_y_continuous(breaks= seq(0, 200000, by=50000), labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw() + #去掉背景色
  theme(panel.grid=element_blank(),  #去掉網線
        panel.border=element_blank(),#去掉邊線
        axis.line=element_line(size=1,colour="black"))+
  annotate('text',x = 0.9 ,y = 175000  ,label = '總共')+
  annotation_custom(tableGrob(table(all$Alley) %>% as.data.frame() ,rows = NULL,cols = NULL), 
                    xmin=0.25, xmax = 1.5, 
                    ymin=120000, ymax=175000)
```

#### Fence
2348個NA
Fence: Fence quality

* GdPrv    Good Privacy
* MnPrv    Minimum Privacy
* GdWo Good Wood
* MnWw Minimum Wood/Wire
* NA   No Fence

```{r Fence}
all$Fence[is.na(all$Fence)] <- 'None'
all %>% 
  filter(!(is.na(SalePrice))) %>%
  ggplot(aes(x=Fence, y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2')+
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw() + #去掉背景色
  theme(panel.grid=element_blank(),  #去掉網線
        panel.border=element_blank(),#去掉邊線
        axis.line=element_line(size=1,colour="black"))+
  annotate('text',x = 3 ,y = 60000  ,label = '總共')+
  annotation_custom(tableGrob(table(all$Fence) %>% as.data.frame() %>% t() ,rows = NULL), 
                    xmin=1.5, xmax = 4.5, 
                    ymin=5000, ymax=75000)
all$Fence <- as.factor(all$Fence)

```

看起來沒有明顯的次序關係，沒有Fence的房屋價格比較高，所以轉成factor。

#### Fireplace
```{r Fireplace}
names(all)[names(all) %>% str_detect("Fireplace") %>% which]
na_col[names(na_col) %>% str_detect("Fireplace") %>% which]
```

##### FireplaceQu
1420個NA
* Ex   Excellent - Exceptional Masonry Fireplace
* Gd   Good - Masonry Fireplace in main level
* TA   Average - Prefabricated Fireplace in main living area or Masonry  Fireplace in basement  
* Fa   Fair - Prefabricated Fireplace in basement
* Po   Poor - Ben Franklin Stove
* NA   No Fireplace

像這種在變數說明或者常理上能夠認知是有次序的，我都會把他轉成數值。

```{r FireplaceQu}
all$FireplaceQu[is.na(all$FireplaceQu)] <- 'None'
all$FireplaceQu<-as.integer(plyr::revalue(all$FireplaceQu,
                                          c('None' = 0, 'Po' = 1, 
                                            'Fa' = 2, 'TA' = 3,
                                            'Gd' = 4, 'Ex' = 5)))
all %>% 
  filter(!(is.na(SalePrice))) %>%
  ggplot(aes(x = FireplaceQu, y = SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2')+
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw() + #去掉背景色
  theme(panel.grid=element_blank(),  #去掉網線
        panel.border=element_blank(),#去掉邊線
        axis.line=element_line(size=1,colour="black"))+
  annotate('text',x = 2 ,y = 290000  ,label = '總共')+
  annotation_custom(tableGrob(table(all$FireplaceQu) %>% as.data.frame() %>% t() ,rows = NULL), 
                    xmin=0, xmax = 4, 
                    ymin=220000, ymax=280000)
```

##### Fireplaces
```{r Fireplaces}
table(all$Fireplaces)
all %>% 
  filter(!(is.na(SalePrice))) %>%
  ggplot(aes(x = Fireplaces, y = SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2')+
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw() + #去掉背景色
  theme(panel.grid=element_blank(),  #去掉網線
        panel.border=element_blank(),#去掉邊線
        axis.line=element_line(size=1,colour="black"))
```


#### Lot
```{r Lot}
names(all)[names(all) %>% str_detect("Lot") %>% which]
na_col[names(na_col) %>% str_detect("Lot") %>% which]
```

##### LotFrontage
LotFrontage: Linear feet of street connected to property
486個NA
初步建模我先根據房屋所在地區的中位數來填補。為什麼呢？拿台灣來說吧，嘉義縣的房子大部分來說要到街上肯定比台北市的房子去到街上還要遠，這就是郊區跟市區的差別。但是這樣還是會有偏誤，以台北市來說北投區內湖區有可能會比中正區信義區還要來的遠，也就是說城市內部也會存在著很大的差異。下一次我有可能會針對這個變數單獨建一個模型來估計它的遺漏值。

```{r LotFrontage_plot,fig.height = 10, fig.width = 14}
all %>% 
  ggplot( aes(x=as.factor(Neighborhood), y=LotFrontage)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", color='deeppink3') +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major=element_line(colour=NA)) 
```

藍色是中位數，咖啡色是標準差。從圖上可以看出部分城鎮跟城鎮以及區域跟區域之間存在著上述所講的差異。

```{r LotFrontage}
#利用dplyr結合ifelse進行向量式填補
all %<>% 
  group_by(Neighborhood) %>% 
  mutate(LotFrontage = ifelse(is.na(LotFrontage),
                              median(LotFrontage,na.rm = T),
                              LotFrontage)) %>% 
  as.data.frame()
```


##### LotShape
沒有NA

* Reg  Regular 
* IR1  Slightly irregular
* IR2  Moderately Irregular
* IR3  Irregular

看起來應該是有次序的變數，但是視覺化後卻不是這樣。

```{r LotShape}
table(all$LotShape)
#將其轉換為數字
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=LotShape, y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major=element_line(colour=NA)) 
#轉為factor
all$LotShape %<>% as.factor()

```


##### LotConfig
沒有NA

* Inside   Inside lot
* Corner   Corner lot
* CulDSac  Cul-de-sac
* FR2  Frontage on 2 sides of property
* FR3  Frontage on 3 sides of property

應該不是有次序的變數，把它轉成factor。

```{r LotConfig}
all$LotConfig %<>% as.factor()
table(all$LotConfig)

```


#### Garage

```{r Garage}
names(all)[names(all) %>% str_detect("Garage") %>% which]
na_col[names(na_col) %>% str_detect("Garage") %>% which]
```

##### GarageYrBlt

GarageYrBlt: Year garage was built 

這邊我會將車庫建造年的NA值改成YearBuilt的年份,NA值有可能是因為該房子沒有車庫,改成YearBuilt的理由類似YearRemodAdd.在說明文件裡面YearRemodAdd: Remodel date (same as construction date if no remodeling or additions).

```{r GarageYrBlt}
all$GarageYrBlt[is.na(all$GarageYrBlt)] <- all$YearBuilt[is.na(all$GarageYrBlt)]

```


##### GarageCars & GarageArea

```{r GarageCars & GarageArea}
all[!is.na(all$GarageType) & is.na(all$GarageFinish),
    c('GarageCars', 'GarageArea', 'GarageType',
      'GarageCond', 'GarageQual', 'GarageFinish')]
```

看起來2127似乎是有車庫,2577沒有,那就把2577改成沒有車庫,2127的GarageCond	GarageQual	GarageFinish的三個NA值改成該變數最多的值

```{r }
all$GarageCond[2127] <- names(sort(-table(all$GarageCond)))[1]
all$GarageQual[2127] <- names(sort(-table(all$GarageQual)))[1]
all$GarageFinish[2127] <- names(sort(-table(all$GarageFinish)))[1]
all[2127,
    c('GarageYrBlt', 'GarageCars', 'GarageArea',
      'GarageType', 'GarageCond', 'GarageQual', 'GarageFinish')]
#修改2577
all$GarageCars[2577] <- 0
all$GarageArea[2577] <- 0
all$GarageType[2577] <- NA

#這樣就讓剩下Garage NA一致了
all[,str_detect(names(all),"Garage")] %>% 
  sapply(is.na) %>% 
  colSums() %>% 
  "["(.!=0)
```

##### GarageType

* 2Types   More than one type of garage
* Attchd   Attached to home
* Basment  Basement Garage
* BuiltIn  Built-In (Garage part of house - typically has room above garage)
* CarPort  Car Port
* Detchd   Detached from home
* NA   No Garage

```{r GarageType}
all$GarageType[is.na(all$GarageType)] <- 'No Garage'
all$GarageType <- as.factor(all$GarageType)
table(all$GarageType)
```

##### GarageFinish

* Fin  Finished
* RFn  Rough Finished  
* Unf  Unfinished
* NA   No Garage

```{r GarageFinish}
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=GarageFinish, y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3',width = 0.5) +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA)) 

all$GarageFinish[is.na(all$GarageFinish)] <- 'None'
all$GarageFinish <- as.integer(plyr::revalue(all$GarageFinish,
                                             c('None'=0, 'Unf'=1, 'RFn'=2, 'Fin'=3)))
table(all$GarageFinish)
```

暗紅色代表標準差，明顯的次序關係我就將其轉成數字。

##### GarageQual

* Ex   Excellent
* Gd   Good
* TA   Typical/Average
* Fa   Fair
* Po   Poor
* NA   No Garage

```{r GarageQual}
all$GarageQual[is.na(all$GarageQual)] <- 'None'
all$GarageQual<-as.integer(plyr::revalue(all$GarageQual, c('None' = 0, 'Po' = 1, 'Fa' = 2,
                                                     'TA' = 3,'Gd' = 4, 'Ex' = 5)))
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=GarageQual, y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3') +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))
```

從圖形上可以看出Poor Garge 幾乎跟沒有Garge一樣，感覺沒有Garge可能還比較好。另外Ex Garage數量稀少所以標準差還比中位數大，可見三個物件彼此相異很大。這邊我會把0和1以及4和5合併增加這個變數的可解釋性。

```{r GarageQual2}
all$GarageQual <- ifelse(all$GarageQual %in% c(0:1),0,
                         ifelse(all$GarageQual %in% c(4:5),3,all$GarageQual - 1))
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=GarageQual, y=SalePrice)) +
  geom_bar(stat = 'summary', fun.y = "median", fill = 'dodgerblue2') +
  geom_bar(stat = 'summary', fun.y = "sd", fill = 'deeppink3',width = 0.5) +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))
```


##### GarageCond

* Ex   Excellent
* Gd   Good
* TA   Typical/Average
* Fa   Fair
* Po   Poor
* NA   No Garage

```{r GarageCond}
all$GarageCond[is.na(all$GarageCond)] <- 'None'
all$GarageCond<-as.integer(plyr::revalue(all$GarageCond, 
                                         c('None' = 0, 'Po' = 1, 'Fa' = 2,
                                           'TA' = 3,'Gd' = 4, 'Ex' = 5)))
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=GarageCond, y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3',width = 0.5) +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))
```


#### Basement

```{r Basement}
na_col[names(na_col) %>% str_detect("Bsmt") %>% which]

```
總共有11個變數和basement有關,其中有六個變數是只有1-2個NA,5個是79-82,先來統計一下這5個變數都是NA的資料筆數有幾個

```{r Basement2}
length(which(is.na(all$BsmtQual) & is.na(all$BsmtCond) & 
             is.na(all$BsmtExposure) & is.na(all$BsmtFinType1) & 
             is.na(all$BsmtFinType2)))
```

可見會有BsmtFinType1不是NA,而其他四個變數則有NA得情況,我得找出這種情況才行


```{r Basement3}
all[!is.na(all$BsmtFinType1) & 
      (is.na(all$BsmtCond)|
       is.na(all$BsmtQual)|
       is.na(all$BsmtExposure)|
       is.na(all$BsmtFinType2)),
    c('BsmtQual', 'BsmtCond', 'BsmtExposure', 'BsmtFinType1', 'BsmtFinType2')]
```

這邊的遺漏值我就用眾數來填補.

```{r Basement4}
all$BsmtFinType2[333] <- names(sort(-table(all$BsmtFinType2)))[1]
all$BsmtExposure[c(949, 1488, 2349)] <- names(sort(-table(all$BsmtExposure)))[1]
all$BsmtCond[c(2041, 2186, 2525)] <- names(sort(-table(all$BsmtCond)))[1]
all$BsmtQual[c(2218, 2219)] <- names(sort(-table(all$BsmtQual)))[1]

```


##### BsmtQual

* Ex   Excellent (100+ inches) 
* Gd   Good (90-99 inches)
* TA   Typical (80-89 inches)
* Fa   Fair (70-79 inches)
* Po   Poor (&lt;70 inches
* NA   No Basement

```{r BsmtQual}
all$BsmtQual[is.na(all$BsmtQual)] <- 'None'
table(all$BsmtQual)
all$BsmtQual<-as.integer(plyr::revalue(all$BsmtQual, 
                                       c('None' = 0, 'Fa' = 1,
                                         'TA' = 2,'Gd' = 3, 'Ex' = 4)))
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=BsmtQual, y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3',width = 0.5) +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))
```


##### BsmtCond

* Ex   Excellent
* Gd   Good
* TA   Typical - slight dampness allowed
* Fa   Fair - dampness or some cracking or settling
* Po   Poor - Severe cracking, settling, or wetness
* NA   No Basement

```{r BsmtCond}
all$BsmtCond[is.na(all$BsmtCond)] <- 'None'
table(all$BsmtCond)
all$BsmtCond<-as.integer(plyr::revalue(all$BsmtCond, c('None' = 0, 'Po' = 1, 'Fa' = 2,
                                                 'TA' = 3,'Gd' = 4)))
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=BsmtCond, y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3',width = 0.5) +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))

```


##### BsmtExposure

* Gd   Good Exposure
* Av   Average Exposure (split levels or foyers typically score average or above)  
* Mn   Mimimum Exposure
* No   No Exposure
* NA   No Basement
   
```{r BsmtExposure}
all$BsmtExposure[is.na(all$BsmtExposure)] <- 'None'
all$BsmtExposure<-as.integer(plyr::revalue(all$BsmtExposure, 
                                           c('None'=0, 'No'=1, 'Mn'=2,
                                             'Av'=3, 'Gd'=4)))
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=BsmtExposure, y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3',width = 0.5) +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))
```


##### BsmtFinType1

* GLQ  Good Living Quarters
* ALQ  Average Living Quarters
* BLQ  Below Average Living Quarters   
* Rec  Average Rec Room
* LwQ  Low Quality
* Unf  Unfinshed
* NA   No Basement

```{r BsmtFinType1}
all$BsmtFinType1[is.na(all$BsmtFinType1)] <- 'None'
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=factor(BsmtFinType1,levels =c('None', 'Unf', 'LwQ',
                                              'Rec', 'BLQ', 'ALQ','GLQ')),
              y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3',width = 0.5) +
  scale_y_continuous(labels = comma) + 
  xlab('BsmtFinType1') +
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))
```

看起來 'LwQ','Rec', 'BLQ', 'ALQ'似乎在售價上面沒甚麼差別，反而Unf還能賣高一點，但是其標準差有點高代表不見得Unf每個物件都能賣高一點。在這邊我會把'LwQ','Rec', 'BLQ', 'ALQ'合併成一個'ABRL'並將這個變數轉為factor。

```{r BsmtFinType1_2}
all$BsmtFinType1 <- ifelse(all$BsmtFinType1 %in% c('LwQ','Rec', 'BLQ', 'ALQ'),
                           'ABRL',all$BsmtFinType1)
all$BsmtFinType1 %<>% factor(levels = c('None','Unf','ABRL','GLQ'))
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=BsmtFinType1,
              y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3',width = 0.5) +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))
```
##### BsmtFinType2

* GLQ  Good Living Quarters
* ALQ  Average Living Quarters
* BLQ  Below Average Living Quarters   
* Rec  Average Rec Room
* LwQ  Low Quality
* Unf  Unfinshed
* NA   No Basement

```{r BsmtFinType2}
all$BsmtFinType2[is.na(all$BsmtFinType2)] <- 'None'

all %>% filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=BsmtFinType2, y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3') +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))
```

情況跟BsmtFinType1類似，但是ALQ似乎有比較跟'LwQ','Rec'和'BLQ'有明顯的差距，可是其標準差高數量又偏少，感覺組內不夠一致。這邊還是會跟BsmtFinType1處理方法依樣，把'LwQ','Rec', 'BLQ', 'ALQ'合併成一個'ABRL'並將這個變數轉為factor。

```{r BsmtFinType2_2}
all$BsmtFinType2 <- ifelse(all$BsmtFinType2 %in% c('LwQ','Rec', 'BLQ', 'ALQ'),
                           'ABRL',all$BsmtFinType2)
all$BsmtFinType2 %<>% factor(levels = c('None','Unf','ABRL','GLQ'))
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=BsmtFinType2,
              y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3',width = 0.5) +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))
```


##### 剩餘的Basement

觀察剩下的Basement變數,顯然都不是含有地下室

```{r rest Basement}
all[(is.na(all$BsmtFullBath) | 
       is.na(all$BsmtHalfBath) |
       is.na(all$BsmtFinSF1) | is.na(all$BsmtFinSF2)|
       is.na(all$BsmtUnfSF) | is.na(all$TotalBsmtSF)),
    c('BsmtQual', 'BsmtFullBath', 'BsmtHalfBath', 'BsmtFinSF1',
      'BsmtFinSF2', 'BsmtUnfSF', 'TotalBsmtSF')]

all$BsmtFullBath[is.na(all$BsmtFullBath)] <-0
all$BsmtHalfBath[is.na(all$BsmtHalfBath)] <-0
all$BsmtFinSF1[is.na(all$BsmtFinSF1)] <-0
all$BsmtFinSF2[is.na(all$BsmtFinSF2)] <-0
all$BsmtUnfSF[is.na(all$BsmtUnfSF)] <-0
all$TotalBsmtSF[is.na(all$TotalBsmtSF)] <-0

```


#### Masonry

```{r Masonry}
na_col[names(na_col) %>% str_detect("MasVnr") %>% which]

```

通常房子有 veneer area,應該也會有 masonry veneer type，來確認一下是不是area 和type的NA都是互相存在在同一筆。

```{r Masonry1}
length(which(is.na(all$MasVnrType) & is.na(all$MasVnrArea)))
```

兩者的NA幾乎都出現在同一筆資料，也就是說type多一筆NA，我就用眾數來填補;但是2611列AREA有值，最多的因子是none,所以用第二多的來填補。


```{r Masonry2}

all[is.na(all$MasVnrType) & !is.na(all$MasVnrArea), c('MasVnrType', 'MasVnrArea')]
all$MasVnrType[2611] <- names(sort(-table(all$MasVnrType)))[2]

```

##### MasVnrType

* BrkCmn   Brick Common
* BrkFace  Brick Face
* CBlock   Cinder Block
* None None
* Stone    Stone

```{r MasVnrType,warning=F,message=F}
all$MasVnrType[is.na(all$MasVnrType)] <- 'None'

grid.arrange(
  ggplot(all, aes(x=MasVnrType, y=SalePrice)) +
    geom_bar(stat='summary', fun.y = "median", fill='grey')+
    scale_y_continuous(labels = comma) + 
    geom_label(stat = "count",aes(label = ..count..,y = ..count..)) + 
    theme_bw() + 
    ggtitle("Median"),
  ggplot(all, aes(x=MasVnrType, y=SalePrice)) +
    geom_bar(stat='summary', fun.y = "mean", fill='black')+
    scale_y_continuous(labels = comma) + 
    geom_label(stat = "count",aes(label = ..count..,y = ..count..)) + 
    theme_bw() + 
    ggtitle("Mean"),
  nrow = 2 ,ncol = 1
)
```

從平均和中位數來看,Brick Common和None似乎在銷售價格上很接近,這邊假設普通石造牆壁和木製一樣便宜,
那這樣我們就把BrkCmn和None合併起來,就能把MasVnrType變數弄成次序的。

```{r MasVnrType1}
all$MasVnrType<-as.integer(plyr::revalue(all$MasVnrType, 
                                         c('None'=0, 'BrkCmn'=0,
                                           'BrkFace'=1, 'Stone'=2)))
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=MasVnrType, y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3',width = 0.5) +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))
```

##### MasVnrArea

```{r MasVnrArea}
all$MasVnrArea[is.na(all$MasVnrArea)] <- 0
```


#### MSZoning

* A    Agriculture
* C    Commercial
* FV   Floating Village Residential
* I    Industrial
* RH   Residential High Density
* RL   Residential Low Density
* RP   Residential Low Density Park 
* RM   Residential Medium Density

因為這個變數是土地的分區，有商業區農業區工業區等等,我覺得應該跟Neighborhood有關連。

```{r MSZoning1}
all %>% 
  group_by(MSZoning,Neighborhood) %>% 
  summarise(value = n()) %>% 
  xtabs(data = .,value~.) %>% 
  kable() %>% 
  scroll_box(width = '100%')
```

由上表可以看出Neighborhood和MSZoning的關聯性，有些地區主要就是農業用地、有些則是商業用地，剩下大部分都是住宅。所以後面會用和Neighborhood有關的方式填補回NA。

```{r MSZoning2}
all[all$MSZoning %>% is.na(),c('MSZoning', 'Neighborhood',"OverallQual")] 
```


4個NA有三個是IDOTRR區一個是Mitchel區。

```{r MSZoning3}
#IDOTRR
filter(all,Neighborhood == "IDOTRR",OverallQual<=5)$MSZoning %>% table
#Mitchel
filter(all,Neighborhood == "Mitchel",OverallQual<=5)$MSZoning %>% table
```


因此這邊1916 2217 2251 將用RM填補，2905將用RL填補。

```{r MSZoning4}
all[c(1916,2217,2251),"MSZoning"] <- "RM"
all[2905,"MSZoning"] <- "RL"
all$MSZoning %<>% as.factor()
```

#### Kitchen

```{r Kitchen}
names(all)[names(all) %>% str_detect("Kitchen") %>% which]
na_col[names(na_col) %>% str_detect("Kitchen") %>% which]
```

##### KitchenQual

* Ex   Excellent
* Gd   Good
* TA   Typical/Average
* Fa   Fair
* Po   Poor

```{r KitchenQual}
table(all$KitchenQual)
all$KitchenQual[is.na(all$KitchenQual)] <- 'TA' #將最多的填補回去
all$KitchenQual<-as.integer(plyr::revalue(all$KitchenQual, 
                                          c('None' = 0, 'Po' = 1, 'Fa' = 2,
                                            'TA' = 3,'Gd' = 4, 'Ex' = 5)))
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=KitchenQual, y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3',width = 0.5) +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))
```

#### Utilities

```{r Utilities}
table(all$Utilities)
```

變數因子嚴重不平衡,這變數對預測沒甚麼幫助,所以就剔除掉

```{r Utilities2}
all$Utilities <- NULL
```

#### Functional

* Typ  Typical Functionality
* Min1 Minor Deductions 1
* Min2 Minor Deductions 2
* Mod  Moderate Deductions
* Maj1 Major Deductions 1
* Maj2 Major Deductions 2
* Sev  Severely Damaged
* Sal  Salvage only

```{r Functional}
na_col[names(na_col) %>% str_detect("Functional") %>% which]
#眾數填補
all$Functional[is.na(all$Functional)] <- names(sort(-table(all$Functional)))[1]
all %>% filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=factor(Functional,
                       levels =  c('Sal','Sev',
                                   'Maj2','Maj1',
                                   'Mod','Min2',
                                   'Min1','Typ')), 
              y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3',width = 0.5) +
  scale_y_continuous(labels = comma) + 
  xlab('Functional') + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))
```

看起來沒辦法轉成次序，且Min1&Min2看起來沒甚麼差，Maj1和Mod看起來也沒甚麼差但是Mod組內標準差太高了我不敢將它跟Maj1合併，這個變數就把Min1&Min2合併成Min然後轉成factor吧。


```{r Functional2}
all$Functional <- ifelse(all$Functional %in% c('Min2','Min1'),
                         'Min',all$Functional)
all$Functional %<>% as.factor()
```
#### Exter

```{r Exter}
names(all)[names(all) %>% str_detect("Exter") %>% which]
na_col[names(na_col) %>% str_detect("Exterior") %>% which]
```

##### Exterior1st

* AsbShng  Asbestos Shingles
* AsphShn  Asphalt Shingles
* BrkComm  Brick Common
* BrkFace  Brick Face
* CBlock   Cinder Block
* CemntBd  Cement Board
* HdBoard  Hard Board
* ImStucc  Imitation Stucco
* MetalSd  Metal Siding
* Other    Other
* Plywood  Plywood
* PreCast  PreCast 
* Stone    Stone
* Stucco   Stucco
* VinylSd  Vinyl Siding
* Wd Sdng  Wood Siding
* WdShing  Wood Shingles

```{r Exterior1st}
#眾數填補
all$Exterior1st[is.na(all$Exterior1st)] <- names(sort(-table(all$Exterior1st)))[1]
all$Exterior1st <- as.factor(all$Exterior1st)
```

##### Exterior2nd

同Exterior1st

```{r Exterior2nd}
all$Exterior2nd[is.na(all$Exterior2nd)] <- names(sort(-table(all$Exterior2nd)))[1]
all$Exterior2nd <- as.factor(all$Exterior2nd)
table(all$Exterior2nd)
```



##### ExterQual

* Ex   Excellent
* Gd   Good
* TA   Average/Typical
* Fa   Fair
* Po   Poor

```{r ExterQual}
all$ExterQual<-as.integer(plyr::revalue(all$ExterQual,
                                        c('None' = 0, 'Po' = 1, 'Fa' = 2,
                                          'TA' = 3,'Gd' = 4, 'Ex' = 5)))
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=ExterQual, y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3',width = 0.5) +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))

```


##### ExterCond

* Ex   Excellent
* Gd   Good
* TA   Average/Typical
* Fa   Fair
* Po   Poor

```{r ExterCond}
all$ExterCond <- as.integer(plyr::revalue(all$ExterCond,
                                          c('None' = 0, 'Po' = 1, 'Fa' = 2,
                                            'TA' = 3,'Gd' = 4, 'Ex' = 5)))

all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=ExterCond, y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3',width = 0.5) +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))
```


##### Electrical

* SBrkr    Standard Circuit Breakers & Romex
* FuseA    Fuse Box over 60 AMP and all Romex wiring (Average) 
* FuseF    60 AMP Fuse Box and mostly Romex wiring (Fair)
* FuseP    60 AMP Fuse Box and mostly knob & tube wiring (poor)
* Mix  Mixed

```{r Electrical}
names(all)[names(all) %>% str_detect("Elect") %>% which]
na_col[names(na_col) %>% str_detect("Elect") %>% which]
#眾數填補
all$Electrical[is.na(all$Electrical)] <- names(sort(-table(all$Electrical)))[1]
all$Electrical <- as.factor(all$Electrical)
table(all$Electrical)

```


#### Sale Type and Condition

```{r Sale Type and Condition}
names(all)[names(all) %>% str_detect("Sale") %>% which][-1]
na_col[names(na_col) %>% str_detect("Sale") %>% which][-1]
```

##### SaleType

```{r SaleType}
#眾數填補
all$SaleType[is.na(all$SaleType)] <- names(sort(-table(all$SaleType)))[1]
all$SaleType <- as.factor(all$SaleType)
table(all$SaleType)
```

##### SaleCondition

* Normal   Normal Sale
* Abnorml  Abnormal Sale -  trade, foreclosure, short sale
* AdjLand  Adjoining Land Purchase
* Alloca   Allocation - two linked properties with separate deeds, typically condo with a garage unit  
* Family   Sale between family members
* Partial  Home was not completed when last assessed (associated with New Homes) number of bedrooms

```{r SaleCondition}
all$SaleCondition <- as.factor(all$SaleCondition)
table(all$SaleCondition)
```


### 剩餘字串變數

```{r charcol}
charcol <- names(all[,sapply(all, is.character)])
charcol
```

#### Foundation

* BrkTil Brick & Tile
* CBlock Cinder Block
* PConc Poured Contrete 
* Slab Slab
* Stone Stone
* Wood Wood

```{r Foundation}
all$Foundation <- as.factor(all$Foundation)
table(all$Foundation)
```

#### Heating and air condition

```{r Heating and air condition}
names(all)[names(all) %>% str_detect("Heating") %>% which]
```

##### Heating

* Floor Floor Furnace
* GasA Gas forced warm air furnace
* GasW Gas hot water or steam heat
* Grav Gravity furnace 
* OthW Hot water or steam heat other than gas
* Wall Wall furnace

```{r Heating}
all$Heating <- as.factor(all$Heating)
table(all$Heating)
```

##### HeatingQC

* Ex   Excellent
* Gd   Good
* TA   Average/Typical
* Fa   Fair
* Po   Poor

```{r HeatingQC}
all$HeatingQC <- as.integer(plyr::revalue(all$HeatingQC, 
                                        c('None' = 0, 'Po' = 1, 'Fa' = 2,
                                          'TA' = 3,'Gd' = 4, 'Ex' = 5)))

all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=HeatingQC, y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3',width = 0.5) +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))

```

##### CentralAir

* N    No
* Y    Yes

布林值，直接把他轉成1和0

```{r CentralAir}
all$CentralAir <- as.integer(plyr::revalue(all$CentralAir, 
                                           c('N'=0, 'Y'=1)))
table(all$CentralAir)
```


#### Roof

```{r Roof}
names(all)[names(all) %>% str_detect("Roof") %>% which]
```


##### RoofStyle

* Flat Flat
* Gable Gable
* Gambrel Gabrel (Barn)
* Hip Hip
* Mansard Mansard
* Shed Shed

```{r RoofStyle}
all$RoofStyle <- as.factor(all$RoofStyle)
table(all$RoofStyle)
```

##### RoofMatl

* ClyTile  Clay or Tile
* CompShg  Standard (Composite) Shingle
* Membran  Membrane
* Metal    Metal
* Roll Roll
* Tar&Grv  Gravel & Tar
* WdShake  Wood Shakes
* WdShngl  Wood Shingles

```{r RoofMatl}
all$RoofMatl <- as.factor(all$RoofMatl)
table(all$RoofMatl)
```

#### Land

```{r Land}
names(all)[names(all) %>% str_detect("Land") %>% which]
```

##### LandContour

* Lvl  Near Flat/Level 
* Bnk  Banked - Quick and significant rise from street grade to building
* HLS  Hillside - Significant slope from side to side
* Low  Depression

```{r LandContour}
all$LandContour <- as.factor(all$LandContour)
table(all$LandContour)
```

##### LandSlope

* Gtl  Gentle slope
* Mod  Moderate Slope  
* Sev  Severe Slope

```{r LandSlope}
table(all$LandSlope)
all$LandSlope <- as.integer(plyr::revalue(all$LandSlope, 
                                          c('Sev' = 0, 'Mod' = 1, 'Gtl' = 2)))

all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=LandSlope, y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3',width = 0.5) +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))

```

將Landslope轉換為次序之後並將其視覺化，可以發現銷售價格似乎並沒有隨著傾斜程度而變動，我就將其改回類別變數吧

```{r LandSlope1}
all$LandSlope %<>% as.factor()
```


#### 住宅相關變數

##### BldgType

* 1Fam Single-family Detached  
* 2FmCon Two-family Conversion; originally built as one-family dwelling
* Duplx Duplex
* TwnhsE Townhouse End Unit
* TwnhsI Townhouse Inside Unit  
註:TwnhsI 在資料裡面少了個I

```{r BldgType}
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=as.factor(BldgType), y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3',width = 0.5) +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))
```


沒有次序關係，轉成類別變數吧


```{r BldgType2}
all$BldgType <- as.factor(all$BldgType)
```



##### HouseStyle 

* 1Story   One story
* 1.5Fin   One and one-half story: 2nd level finished
* 1.5Unf   One and one-half story: 2nd level unfinished
* 2Story   Two story
* 2.5Fin   Two and one-half story: 2nd level finished
* 2.5Unf   Two and one-half story: 2nd level unfinished
* SFoyer   Split Foyer
* SLvl     Split Level

```{r HouseStyle}
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=HouseStyle, y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3',width = 0.5) +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))
#轉成factor
all$HouseStyle <- as.factor(all$HouseStyle)
```


#### Neighborhood 

```{r Neighborhood}
table(all$Neighborhood)
```


毫無懸念就是factor

```{r Neighborhood2}

all$Neighborhood <- as.factor(all$Neighborhood)
```

#### Condition

##### Condition1

* Artery   Adjacent to arterial street
* Feedr    Adjacent to feeder street   
* Norm Normal  
* RRNn Within 200' of North-South Railroad
* RRAn Adjacent to North-South Railroad
* PosN Near positive off-site feature--park, greenbelt, etc.
* PosA Adjacent to postive off-site feature
* RRNe Within 200' of East-West Railroad
* RRAe Adjacent to East-West Railroad

```{r Condition1}
table(all$Condition1)
all$Condition1 <- as.factor(all$Condition1)
```


##### Condition2

* Artery   Adjacent to arterial street
* Feedr    Adjacent to feeder street   
* Norm Normal  
* RRNn Within 200' of North-South Railroad
* RRAn Adjacent to North-South Railroad
* PosN Near positive off-site feature--park, greenbelt, etc.
* PosA Adjacent to postive off-site feature
* RRNe Within 200' of East-West Railroad
* RRAe Adjacent to East-West Railroad

```{r Condition2}
table(all$Condition2)
all$Condition1 <- as.factor(all$Condition2)
```


#### Street & PavedDrive

##### Street

Street: Type of road access to property

* Grvl Gravel  
* Pave Paved

```{r Street}
table(all$Street)
all$Street<-as.integer(plyr::revalue(all$Street, c('Grvl'=0, 'Pave'=1)))
```


##### PavedDrive

PavedDrive: Paved driveway

* Y    Paved 
* P    Partial Pavement
* N    Dirt/Gravel

我覺得可以轉成次序的

```{r PavedDrive}
table(all$PavedDrive)
all$PavedDrive<-as.integer(plyr::revalue(all$PavedDrive,
                                         c('N'=0, 'P'=1, 'Y'=2)))
all %>% 
  filter(!(is.na(SalePrice))) %>% 
  ggplot( aes(x=PavedDrive, y=SalePrice)) +
  geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2') +
  geom_bar(stat='summary', fun.y = "sd", fill='deeppink3',width = 0.5) +
  scale_y_continuous(labels = comma) + 
  geom_label(stat = "count",aes(label = ..count..,y = ..count..)) +
  theme_bw()+
  theme(axis.text.x = element_text(hjust = 1),
        panel.grid.major=element_line(colour=NA))

```

### 數值變數轉成類別變數

#### MoSold

這邊將月份轉成類別變數的原因是房價銷售的價格並不會隨著月份增加而價格增加，這樣很奇怪不太合理。

```{r MoSold}
all$MoSold <- as.factor(all$MoSold)
grid.arrange(
  ggplot(all[!is.na(all$SalePrice),], aes(x=as.factor(YrSold), y=SalePrice)) +
    geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2')+
    scale_y_continuous(breaks= seq(0, 800000, by=25000), labels = comma) +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..)) +
    coord_cartesian(ylim = c(0, 200000)) +
    geom_hline(yintercept=163000, linetype="dashed", color = "red"), #dashed line is median SalePrice
  ggplot(all[!is.na(all$SalePrice),], aes(x=MoSold, y=SalePrice)) +
    geom_bar(stat='summary', fun.y = "median", fill='dodgerblue2')+
    scale_y_continuous(breaks= seq(0, 800000, by=25000), labels = comma) +
    geom_label(stat = "count", aes(label = ..count.., y = ..count..)) +
    coord_cartesian(ylim = c(0, 200000)) +
    geom_hline(yintercept=163000, linetype="dashed", color = "red"), #dashed line is median SalePrice
  widths=c(1,2)
  )
```


#### MSSubClass

MSSubClass: Identifies the type of dwelling involved in the sale.

* 20  1-STORY 1946 & NEWER ALL STYLES
* 30  1-STORY 1945 & OLDER
* 40  1-STORY W/FINISHED ATTIC ALL AGES
* 45  1-1/2 STORY - UNFINISHED ALL AGES
* 50  1-1/2 STORY FINISHED ALL AGES
* 60  2-STORY 1946 & NEWER
* 70  2-STORY 1945 & OLDER
* 75  2-1/2 STORY ALL AGES
* 80  SPLIT OR MULTI-LEVEL
* 85  SPLIT FOYER
* 90  DUPLEX - ALL STYLES AND AGES
* 120  1-STORY PUD (Planned Unit Development) - 1946 & NEWER
* 150  1-1/2 STORY PUD - ALL AGES
* 160  2-STORY PUD - 1946 & NEWER
* 180  PUD - MULTILEVEL - INCL SPLIT LEV/FOYER
* 190  2 FAMILY CONVERSION - ALL STYLES AND AGES

看起來應該就是直接轉factor了，數字基本上只是被用來區分銷售上的類別而已

```{r MSSubClass}
table(all$MSSubClass)
all$MSSubClass <- as.factor(all$MSSubClass)

```

###小結

檢視一下處理過後連續變數和類別變數數量。

```{r afterClean}
num_var2 <- which(sapply(all, is.numeric)) 
factor_var <- which(sapply(all, is.factor))
cat('總共有', length(num_var2), '連續變數, and',
    length(factor_var), '類別變數')
```

類別變數被我從43個減少到24個、數值變數則從38個增加到55個，比較有利於後續模型建模。

## 探索資料分析

### 相關性

由於前面資料清洗的部分已經先處理過資料一輪，下面再畫一次處理前和處理後數值變數相關性的圖來比較一下差異。這邊因為corrplot不是grob物件，沒辦法用grid.arrange，[stackoverflow](https://stackoverflow.com/questions/53734543/converting-corrplot-output-to-grob)這邊有解法能夠將corrplot轉成grob物件，但是我還是先用base套件來繪圖。

```{r CorplotAfter,warning=F,out.width='\\textwidth',fig.height=10,fig.width=12}
#相關性
CorNumvar_after <- cor(all[, num_var2], 
                  use="pairwise.complete.obs") 
CorSortName_after <- sort(CorNumvar_after[,'SalePrice'], 
                      decreasing = TRUE) %>% 
                     as.matrix() %>% 
                     apply(1, function(x) abs(x)>0.5) %>% 
                     which() %>% 
                     names()
CorNumvarSort <- CorNumvar_after[CorSortName_after, CorSortName_after]

oldpar <- par()
par(mfrow = c(1,2))
corrplot.mixed(cor_numvar_sort,
               tl.col="black",
               tl.pos = "lt",
               tl.cex = 0.7, #標題大小
               cl.cex = 0.7, #color bar 大小
               number.cex=0.7,
               title = 'BEROFE',
               mar=c(0,0,2,0))

corrplot.mixed(CorNumvarSort, 
               tl.col="black", 
               tl.pos = "lt", 
               tl.cex = 0.7, #標題大小
               cl.cex = 0.7, #color bar 大小
               number.cex=0.7,
               title = 'AFTER',
               mar=c(0,0,2,0))
par(oldpar)

```


### 重要性

<span style="color:red">隨機森林</span>有個很好用的功能就是它能幫你選出對預測有幫助的特徵。它的作法就是底層建一大堆樹，每一根樹都會隨機對資料抽n個樣本，對特徵隨機抽y個特徵。那為什麼說它能幫你挑選特徵呢，因為它能對預測效果好的樹count它所使用的特徵，最後再排序每個特徵被選取的次數來建立特徵的重要性。

```{r RandomForest,eval = FALSE,}
set.seed(2018)
quick_RF <- randomForest(x=all %>% 
                            filter(!(is.na(SalePrice))) %>% 
                            select(-SalePrice,-Id),
                         
                         y=all %>% 
                            filter(!(is.na(SalePrice))) %>% 
                            "$"(SalePrice),
                         ntree=100,importance=TRUE)
imp_RF <- importance(quick_RF)
imp_DF <- data.frame(Variables = row.names(imp_RF),
                     MSE = imp_RF[,1]) %>% 
          arrange(desc(MSE))

important <- ggplot(imp_DF[1:30,], 
                    aes(x=reorder(Variables, MSE),
                        y=MSE, 
                        fill=MSE)) + 
             geom_bar(stat = 'identity') + 
             scale_y_continuous(labels = function(x)paste0(x,'%')) +
             labs(x = '變數', 
                  y= '替換掉MSE會提升的%數') + 
             coord_flip() + 
             theme(legend.position="none",
                   axis.text.x = element_text(size = 25,
                                              face = 'bold'),
                   axis.text.y = element_text(size = 30,
                                              face = 'bold'),
                   axis.title.x = element_text(size = 30,
                                               face = 'bold'),
                   axis.title.y = element_text(size = 30,
                                               face = 'bold')) 
```


![](output/importance.png)

最重要的幾個變數GrLivArea、Neighborhood和OverallQual都超過10%，表示如過拿掉該變數誤差大約會提升10%以上。接下來幾個小節我會依照重要性排名前幾名做個簡單的EDA並且視覺化它們。

###和GrLivArea相關特徵

```{r GrLivAreaEDA}
grid.arrange(all %>% ggplot() +
               geom_density(aes(x = GrLivArea),
                            fill = 'pink',color = 'deeppink') + 
               GGvisualize_theme(),
             all %>% ggplot() +
               geom_density(aes(x = X1stFlrSF),
                            fill = 'pink',color = 'deeppink') + 
               GGvisualize_theme(),
             all %>% ggplot() +
               geom_density(aes(x = X2ndFlrSF),
                            fill = 'pink',color = 'deeppink') + 
               GGvisualize_theme(),
             all %>% filter() %>% ggplot()+
               geom_density(aes(x = LowQualFinSF),
                            fill = 'pink',color = 'deeppink') + 
               GGvisualize_theme(),
             all %>% ggplot() +
               geom_density(aes(x = TotalBsmtSF),
                            fill = 'pink',color = 'deeppink') + 
               GGvisualize_theme(),
             all %>% filter(LotArea< 50000) %>% ggplot()+
               geom_density(aes(x = LotArea) ,
                            fill = 'pink',color = 'deeppink') + 
               GGvisualize_theme(),
             all %>% ggplot()+
               geom_density(aes(x = LotFrontage),
                            fill = 'pink',color = 'deeppink') + 
               GGvisualize_theme(),
             all %>% ggplot() +
               geom_density(aes(x = TotRmsAbvGrd),
                            fill = 'pink',color = 'deeppink') + 
               scale_x_continuous(breaks = seq(0,max(all$TotRmsAbvGrd))) + 
               GGvisualize_theme(),
             layout_matrix = matrix(1:8,4,2,byrow=TRUE))

grid.arrange(all %>% ggplot() +
               geom_point(aes(x = GrLivArea ,y=SalePrice),
                            fill = 'pink',color = 'deeppink') + 
               scale_x_continuous(breaks = seq(0,6000,1000),limits = c(0,7000)) + 
               scale_y_continuous(limits = c(0,700000)) + 
               GGvisualize_theme(),
             all %>% ggplot() +
               geom_point(aes(x = X1stFlrSF ,y=SalePrice),
                            fill = 'pink',color = 'deeppink') + 
               scale_x_continuous(breaks = seq(0,6000,1000),limits = c(0,7000)) + 
               scale_y_continuous(limits = c(0,700000)) + 
               GGvisualize_theme(),
             all %>% filter(X2ndFlrSF != 0 ) %>% 
               ggplot() +
               geom_point(aes(x = X2ndFlrSF ,y=SalePrice),
                            fill = 'pink',color = 'deeppink') + 
               scale_x_continuous(breaks = seq(0,6000,1000),limits = c(0,7000)) + 
               scale_y_continuous(limits = c(0,700000)) + 
               GGvisualize_theme(),
             all %>% filter(LowQualFinSF != 0 ) %>% 
               ggplot()+
               geom_point(aes(x = LowQualFinSF ,y=SalePrice),
                          fill = 'pink',color = 'deeppink') + 
               scale_x_continuous(breaks = seq(0,6000,1000),limits = c(0,7000)) + 
               scale_y_continuous(limits = c(0,700000)) + 
               GGvisualize_theme(),
             all %>% ggplot() +
               geom_point(aes(x = TotalBsmtSF ,y=SalePrice),
                            fill = 'pink',color = 'deeppink') + 
               scale_x_continuous(breaks = seq(0,6000,1000),limits = c(0,7000)) + 
               scale_y_continuous(limits = c(0,700000)) + 
               GGvisualize_theme(),
             all %>% ggplot() +
               geom_point(aes(x = TotRmsAbvGrd ,y=SalePrice),
                          fill = 'pink',color = 'deeppink') + 
               GGvisualize_theme(),
             all %>% filter(LotArea< 50000) %>% ggplot()+
               geom_point(aes(x = LotArea ,y=SalePrice) ,
                            fill = 'pink',color = 'deeppink') + 
               scale_x_continuous(breaks = seq(0,6000,1000),limits = c(0,7000)) + 
               scale_y_continuous(limits = c(0,700000)) + 
               GGvisualize_theme(),
             all %>% ggplot()+
               geom_point(aes(x = LotFrontage ,y=SalePrice),
                            fill = 'pink',color = 'deeppink') + 
               scale_x_continuous(breaks = seq(0,6000,1000),limits = c(0,7000)) + 
               scale_y_continuous(limits = c(0,700000)) + 
               GGvisualize_theme(),
             
             layout_matrix = matrix(1:8,4,2,byrow=TRUE))
```

GrLivArea: Above grade (ground) living area square feet
1stFlrSF: First Floor square feet
2ndFlrSF: Second floor square feet
LowQualFinSF: Low quality finished square feet (all floors)
TotalBsmtSF: Total square feet of basement area
LotArea: Linear feet of size in square feet
LotFrontage: Linear feet of street connected to property
TotRmsAbvGrd: Total rooms above grade (does not include bathrooms)


































